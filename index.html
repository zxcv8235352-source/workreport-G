<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å·¥ç¨‹æ—¥å ±ç³»çµ± - å¤šå·¥ç¨®æ˜ç´°ç‰ˆ</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #2196F3; --success: #4CAF50; --light: #f5f5f5; --border: #ddd; --dark: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: var(--light); color: var(--dark); }
        
        /* ç™»å…¥é é¢ */
        #loginPage { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px; }

        /* ä¸»ç¨‹å¼ */
        #mainApp { display: none; flex-direction: column; min-height: 100vh; }
        .header { background: #1e3a8a; color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; }
        .content { flex: 1; padding: 15px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* å¡ç‰‡æ¨£å¼ (ç”¨æ–¼ä¸åŒå·¥ç¨®é …ç›®) */
        .item-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; }
        textarea { resize: none; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; margin-bottom: 20px; cursor: pointer; }
        .btn-submit { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(76,175,80,0.3); }
        .btn-submit:disabled { background: #ccc; }
        .btn-remove { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2>ğŸ—ï¸ å·¥ç¨‹ç®¡ç†ç³»çµ±</h2>
            <p style="margin: 20px 0; color: #666;">è«‹ä½¿ç”¨å…¬å¸å¸³è™Ÿç™»å…¥</p>
            <div id="googleBtn" style="display: flex; justify-content: center;"></div>
        </div>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>æ¯æ—¥æ–½ä½œè©³å ±</h3>
                <button onclick="logout()" style="background:none; border:1px solid white; color:white; padding:4px 8px; border-radius:4px;">ç™»å‡º</button>
            </div>
            <div id="userLabel" style="font-size: 12px; margin-top: 5px; opacity: 0.8;"></div>
        </div>

        <div class="content">
            <div class="item-card" style="border-left: 5px solid #333;">
                <div class="form-group">
                    <label>å·¥åœ°åç¨±</label>
                    <input type="text" id="siteName" placeholder="è«‹è¼¸å…¥å·¥åœ°/å»ºæ¡ˆåç¨±">
                </div>
                <div class="form-group">
                    <label>å ±è¡¨æ—¥æœŸ</label>
                    <input type="date" id="reportDate">
                </div>
            </div>

            <div id="itemsContainer">
                </div>

            <button class="btn-add" onclick="addItemCard()">ï¼‹ æ–°å¢æ–½ä½œé …ç›® (å¦‚ï¼šé‹¼ç­‹ã€æ¨¡æ¿)</button>
            
            <div class="form-group">
                <label>ğŸ“¸ ç¾å ´æ–½å·¥ç…§ç‰‡ (å¯ä¸€æ¬¡é¸å–å¤šå¼µ)</label>
                <input type="file" id="allPhotos" accept="image/*" capture="environment" multiple>
            </div>

            <button id="submitBtn" class="btn-submit" onclick="submitForm()">ğŸš€ å®Œæ•´æäº¤æ—¥å ±</button>
        </div>
    </div>

<script>
    const GAS_URL = 'ä½ çš„_GAS_éƒ¨ç½²ç¶²å€'; // <--- è«‹å¡«å…¥æ‚¨çš„ GAS URL
    const CLIENT_ID = '240527365724-gg80b8eip9c8qq4qd40mem7r4799rjur.apps.googleusercontent.com';

    let currentUser = null;

    // 1. åˆå§‹åŒ–èˆ‡ä¿æŒç™»å…¥é‚è¼¯
    window.onload = function() {
        google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse,
            auto_select: true // å˜—è©¦è‡ªå‹•ç™»å…¥
        });
        
        google.accounts.id.renderButton(document.getElementById('googleBtn'), { theme: 'outline', size: 'large' });

        // è¨­å®šé è¨­æ—¥æœŸ
        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

        // æ ¸å¿ƒï¼šæª¢æŸ¥æœ¬åœ°å„²å­˜çš„ç™»å…¥è³‡è¨Š
        const savedUser = localStorage.getItem('mekong_user');
        const loginTimestamp = localStorage.getItem('mekong_login_time');
        const now = new Date().getTime();

        // å¦‚æœæœ‰ç´€éŒ„ä¸”åœ¨ 30 åˆ†é˜å…§ (30 * 60 * 1000 æ¯«ç§’)
        if (savedUser && loginTimestamp && (now - loginTimestamp < 1800000)) {
            currentUser = JSON.parse(savedUser);
            showApp();
        } else {
            localStorage.clear(); // è¶…æ™‚æˆ–ç„¡ç´€éŒ„å‰‡æ¸…ç©º
        }
        
        addItemCard(); // åˆå§‹åŒ–ä¸€å€‹å·¥ç¨®å¡ç‰‡
    };

    function handleCredentialResponse(response) {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        if (!payload.email.endsWith('@mekongkh.net')) {
            alert('åƒ…é™å…¬å¸å¸³è™Ÿç™»å…¥ï¼');
            return;
        }
        currentUser = payload;
        // å„²å­˜ç™»å…¥è³‡è¨Šèˆ‡ç›®å‰æ™‚é–“æˆ³
        localStorage.setItem('mekong_user', JSON.stringify(payload));
        localStorage.setItem('mekong_login_time', new Date().getTime().toString());
        showApp();
    }

    function showApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userLabel').textContent = `äººå“¡ï¼š${currentUser.name} (${currentUser.email})`;
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // 2. å·¥ç¨®é …ç›®å‹•æ…‹æ¬„ä½
    function addItemCard() {
        const container = document.getElementById('itemsContainer');
        const id = Date.now();
        const card = document.createElement('div');
        card.className = 'item-card';
        card.id = `card-${id}`;
        card.innerHTML = `
            <div class="item-header">
                <input type="text" class="item-name" placeholder="å·¥ç¨®åç¨± (å¦‚ï¼šé‹¼ç­‹ã€æ¨¡æ¿)" style="width:70%; font-weight:bold; border:none; border-bottom:1px solid #ccc;">
                <button class="btn-remove" onclick="document.getElementById('card-${id}').remove()">åˆªé™¤</button>
            </div>
            <div class="form-group">
                <label>ğŸ“ æ–½ä½œç¯„åœ/ä½ç½®</label>
                <input type="text" class="item-range" placeholder="ä¾‹å¦‚ï¼š2F æ¨‘æŸ±">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>ğŸ‘· å‡ºå·¥æ•¸ (äºº)</label>
                    <input type="number" class="item-workers" placeholder="0">
                </div>
                <div class="form-group">
                    <label>ğŸ“ æ–½ä½œæ•¸é‡</label>
                    <input type="text" class="item-qty" placeholder="ä¾‹å¦‚ï¼š50 m2">
                </div>
            </div>
            <div class="form-group">
                <label>ğŸ“¦ ç”¨æ–™æ•¸é‡</label>
                <input type="text" class="item-material" placeholder="ä¾‹å¦‚ï¼šæ°´æ³¥ 20 åŒ…">
            </div>
            <div class="form-group">
                <label>ğŸ’¡ ç‰¹æ®Šæƒ…æ³/æ³¨æ„äº‹é …</label>
                <textarea class="item-note" rows="2" placeholder="å‚™è¨»ç‰¹æ®Šç¾å ´ç‹€æ³..."></textarea>
            </div>
        `;
        container.appendChild(card);
    }

    // 3. æäº¤é‚è¼¯
    async function submitForm() {
        const siteName = document.getElementById('siteName').value;
        const photos = document.getElementById('allPhotos').files;

        if (!siteName || photos.length === 0) {
            alert('è«‹å¡«å¯«å·¥åœ°åç¨±ä¸¦è‡³å°‘æ‹æ”ä¸€å¼µæ–½å·¥ç…§ç‰‡ï¼');
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = 'æ­£åœ¨è™•ç†ç…§ç‰‡èˆ‡è³‡æ–™...';

        // æ”¶é›†æ‰€æœ‰å·¥ç¨®å¡ç‰‡è³‡æ–™
        const items = [];
        document.querySelectorAll('.item-card').forEach(card => {
            const name = card.querySelector('.item-name')?.value;
            if (name) {
                items.push({
                    å·¥ç¨®: name,
                    ç¯„åœ: card.querySelector('.item-range').value,
                    å‡ºå·¥æ•¸: card.querySelector('.item-workers').value,
                    æ–½ä½œé‡: card.querySelector('.item-qty').value,
                    ç”¨æ–™: card.querySelector('.item-material').value,
                    æ³¨æ„äº‹é …: card.querySelector('.item-note').value
                });
            }
        });

        try {
            // è½‰æ›å¤šå¼µç…§ç‰‡
            const photoData = [];
            for (let file of photos) {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(file);
                });
                photoData.push({ base64 });
            }

            const payload = {
                user: currentUser.email,
                userName: currentUser.name,
                siteName: siteName,
                reportDate: document.getElementById('reportDate').value,
                details: items, // é€™è£¡åŒ…å«äº†æ‰€æœ‰å·¥ç¨®çš„æ˜ç´°
                photos: photoData
            };

            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });

            alert('âœ… æäº¤å®Œæˆï¼');
            location.reload();
        } catch (e) {
            alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
