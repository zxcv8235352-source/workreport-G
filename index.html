<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å·¥ç¨‹æ—¥å ± APP</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --card: #ffffff; --text: #202124; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }

        /* APP æ¨™é ­ */
        header { background: var(--primary); color: white; padding: 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        
        /* ç™»å…¥ä»‹é¢å„ªåŒ– */
        #loginPage { display: flex; align-items: center; justify-content: center; height: 100vh; background: #fff; padding: 24px; }
        .login-box { text-align: center; width: 100%; }
        .login-box h1 { font-size: 24px; margin-bottom: 8px; }

        /* å¡ç‰‡å¼ä½ˆå±€ */
        #mainApp { display: none; padding: 12px; padding-bottom: 100px; }
        .section-card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: var(--primary); display: flex; justify-content: space-between; }

        /* è¡¨å–®å…ƒç´ å„ªåŒ– (åŠ å¤§è§¸æ§é¢ç©) */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; margin-bottom: 6px; color: #5f6368; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        input:focus { border-color: var(--primary); }
        
        /* å‹•æ…‹å·¥ç¨®å¡ç‰‡ */
        .work-item { background: #f1f3f4; border-radius: 8px; padding: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
        
        /* åº•éƒ¨æ“ä½œåˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px; border-top: 1px solid #eee; display: flex; gap: 12px; }
        .btn { border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; padding: 12px; }
        .btn-add { background: #e8f0fe; color: var(--primary); flex: 1; }
        .btn-submit { background: var(--primary); color: white; flex: 2; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-box">
            <h1>ğŸš§ å·¥ç¨‹æ—¥å ±ç³»çµ±</h1>
            <p style="color:#5f6368; margin-bottom:32px;">è«‹ä½¿ç”¨å…¬å¸å¸³è™Ÿç™»å…¥</p>
            <div id="googleBtn"></div>
        </div>
    </div>

    <div id="mainApp">
        <header>
            <span id="userName" style="font-weight:bold;">æ—¥å ±å¡«å¯«</span>
            <button onclick="logout()" style="background:none; border:none; color:white; font-size:14px;">ç™»å‡º</button>
        </header>

        <div class="section-card">
            <div class="form-group"><label>å·¥åœ°åç¨±</label><input type="text" id="siteName" placeholder="ä¾‹å¦‚ï¼šä¸­å±±åŒ—è·¯å»ºæ¡ˆ"></div>
            <div class="form-group"><label>å ±è¡¨æ—¥æœŸ</label><input type="date" id="reportDate"></div>
        </div>

        <div id="workList">
            </div>

        <div class="section-card">
            <div class="section-title">ğŸ“¸ ç¾å ´æ–½å·¥ç…§ç‰‡</div>
            <input type="file" id="constPhotos" accept="image/*" capture="environment" multiple style="border:none; padding:0;">
            <p style="font-size:12px; color:#5f6368; margin-top:8px;">æç¤ºï¼šå¯å¤šé¸ç…§ç‰‡ï¼Œç³»çµ±æœƒè‡ªå‹•æ­¸æª”</p>
        </div>

        <div class="bottom-nav">
            <button class="btn btn-add" onclick="addWorkItem()">ï¼‹ å¢åŠ å·¥ç¨®</button>
            <button id="submitBtn" class="btn btn-submit" onclick="submitForm()">ç™¼é€æ—¥å ±</button>
        </div>
    </div>

<script>
    const GAS_URL = 'ä½ çš„_GAS_URL'; 
    const CLIENT_ID = '240527365724-gg80b8eip9c8qq4qd40mem7r4799rjur.apps.googleusercontent.com'; [cite: 168]

    let currentUser = null;

    window.onload = function() {
        google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse });
        google.accounts.id.renderButton(document.getElementById('googleBtn'), { size: 'large', width: '280' });
        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0]; [cite: 169]

        // æª¢æŸ¥ 30 åˆ†é˜ç™»å…¥æŒä¹…åŒ–
        const saved = localStorage.getItem('engineering_user');
        const loginTime = localStorage.getItem('login_timestamp');
        if (saved && loginTime && (Date.now() - loginTime < 1800000)) { // 30min = 1800000ms
            currentUser = JSON.parse(saved);
            showApp();
        }
        addWorkItem(); // é è¨­æ–°å¢ä¸€å€‹
    };

    function handleCredentialResponse(response) {
        const data = JSON.parse(atob(response.credential.split('.')[1]));
        if (!data.email.endsWith('@mekongkh.net')) { alert('é™å…¬å¸å¸³è™Ÿï¼'); return; } [cite: 172]
        currentUser = data;
        localStorage.setItem('engineering_user', JSON.stringify(data));
        localStorage.setItem('login_timestamp', Date.now());
        showApp();
    }

    function showApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.name;
    }

    function logout() { localStorage.clear(); location.reload(); }

    function addWorkItem() {
        const div = document.createElement('div');
        div.className = 'section-card work-item';
        div.innerHTML = `
            <div class="form-group"><label>å·¥ç¨® (å¦‚ï¼šé‹¼ç­‹ã€æ¨¡æ¿)</label><input type="text" class="w-type"></div>
            <div class="form-group"><label>æ–½ä½œç¯„åœ/æ•¸é‡</label><input type="text" class="w-qty" placeholder="ä¾‹å¦‚ï¼š3Fæ¨‘æŸ± / 50m2"></div>
            <div style="display:flex; gap:8px;">
                <div class="form-group" style="flex:1;"><label>å‡ºå·¥æ•¸</label><input type="number" class="w-people"></div>
                <div class="form-group" style="flex:1;"><label>ç”¨æ–™æ•¸é‡</label><input type="text" class="w-material"></div>
            </div>
            <div class="form-group"><label>æ³¨æ„äº‹é …/ç‰¹æ®Šæƒ…æ³</label><textarea class="w-note" rows="2"></textarea></div>
            <button onclick="this.parentElement.remove()" style="color:#d93025; background:none; border:none; font-size:12px;">âœ• ç§»é™¤æ­¤é …ç›®</button>
        `;
        document.getElementById('workList').appendChild(div);
    }

    async function submitForm() {
        const btn = document.getElementById('submitBtn');
        const photoFiles = document.getElementById('constPhotos').files;
        if (photoFiles.length === 0) { alert('è«‹è‡³å°‘æ‹ä¸€å¼µç…§ï¼'); return; }

        btn.disabled = true; btn.innerText = 'å‚³é€ä¸­...';

        const details = [];
        document.querySelectorAll('.work-item').forEach(el => {
            if(el.querySelector('.w-type').value) {
                details.push({
                    type: el.querySelector('.w-type').value,
                    qty: el.querySelector('.w-qty').value,
                    people: el.querySelector('.w-people').value,
                    material: el.querySelector('.w-material').value,
                    note: el.querySelector('.w-note').value
                });
            }
        });

        try {
            const photos = await Promise.all(Array.from(photoFiles).map(async (f, i) => ({
                type: `æ–½å·¥_${i+1}`, base64: await new Promise(r => {
                    const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f);
                })
            }))); [cite: 183]

            await fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({
                    user: currentUser.email,
                    siteName: document.getElementById('siteName').value,
                    reportDate: document.getElementById('reportDate').value,
                    details: details,
                    photos: photos
                })
            });
            alert('âœ… æäº¤æˆåŠŸï¼'); location.reload();
        } catch (e) { alert('å¤±æ•—'); btn.disabled = false; }
    }
</script>
</body>
</html>
